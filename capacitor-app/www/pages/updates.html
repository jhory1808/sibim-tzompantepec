<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizaciones del Sistema - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="logo">SIBIMTZOMP</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="../index.html" class="btn btn-outline">Volver</a>
        </div>
    </header>

    <main style="padding: 20px 5%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <div>
                <h1 style="color: var(--accent-blue);">Registro de Actualizaciones</h1>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Trazabilidad detallada de cambios en
                    registros y parámetros</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="background: #2ecc71; color: white;" onclick="loadUpdates()"><i
                        class="fas fa-sync"></i> Actualizar Listado</button>
            </div>
        </div>

        <div class="glass" style="padding: 0; overflow-x: auto; border-radius: 12px; margin-bottom: 50px;">
            <table style="width: 100%; border-collapse: collapse; min-width: 1800px;">
                <thead style="background: rgba(0,0,0,0.2);">
                    <tr>
                        <th style="padding: 15px; text-align: left;">ID</th>
                        <th style="padding: 15px; text-align: left;">Fecha/Hora</th>
                        <th style="padding: 15px; text-align: left;">Usuario</th>
                        <th style="padding: 15px; text-align: left;">Tipo</th>
                        <th style="padding: 15px; text-align: left;">Tabla</th>
                        <th style="padding: 15px; text-align: left;">ID Reg.</th>
                        <th style="padding: 15px; text-align: left;">Campo</th>
                        <th style="padding: 15px; text-align: left;">Val. Anterior</th>
                        <th style="padding: 15px; text-align: left;">Val. Nuevo</th>
                        <th style="padding: 15px; text-align: left;">Descripción</th>
                        <th style="padding: 15px; text-align: center;">Versión / IP</th>
                    </tr>
                </thead>
                <tbody id="updates-table-body">
                    <tr>
                        <td colspan="11" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-spinner fa-spin"></i> Consultando registros de auditoría...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            Auth.checkAccess();
            Auth.initTheme();
            loadUpdates();
        });

        async function loadUpdates() {
            const tbody = document.getElementById('updates-table-body');
            try {
                const updates = await API.getUpdates();
                renderUpdates(updates);
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; color:red; padding:20px;">Error al conectar con la base de datos de auditoría.</td></tr>`;
            }
        }

        function renderUpdates(data) {
            const tbody = document.getElementById('updates-table-body');
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:20px;">No se registraron actualizaciones recientes.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(u => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem;">
                    <td style="padding: 12px 15px;">${u.ID || u.id || '---'}</td>
                    <td style="padding: 12px 15px;">
                        <div>${u.Fecha || ''}</div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary);">${u.Hora || ''}</div>
                    </td>
                    <td style="padding: 12px 15px; font-weight: bold;">${u.Usuario || '---'}</td>
                    <td style="padding: 12px 15px;"><span class="badge" style="background: rgba(52, 152, 219, 0.2); color: #3498db; padding: 3px 6px; border-radius: 4px;">${u['Tipo Actualizacion'] || 'MOD'}</span></td>
                    <td style="padding: 12px 15px;">${u['Tabla afectada'] || '---'}</td>
                    <td style="padding: 12px 15px; font-family: monospace;">#${u['ID Registro'] || '---'}</td>
                    <td style="padding: 12px 15px; color: var(--accent-blue);">${u['Campo Modificado'] || '---'}</td>
                    <td style="padding: 12px 15px; color: #e74c3c;">${u['Valor Anterior'] || '---'}</td>
                    <td style="padding: 12px 15px; color: #2ecc71;">${u['Valor Nuevo'] || '---'}</td>
                    <td style="padding: 12px 15px; font-size: 0.75rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${u.Descripcion || '---'}</td>
                    <td style="padding: 12px 15px; text-align: center;">
                        <div style="font-weight: bold;">v${u.Version || '1.0'}</div>
                        <div style="font-size: 0.65rem; color: var(--text-secondary);">${u.IP || '---'}</div>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>

</html>