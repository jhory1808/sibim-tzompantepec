<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="logo">SIBIMTZOMP</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="../index.html" class="btn btn-outline" style="padding: 10px 15px;">Volver</a>
        </div>
    </header>

    <main style="padding: 20px 5%;">
        <div class="header-actions no-print"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <div>
                <h1 style="color: var(--accent-blue);">Configuración del Sistema</h1>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Configuración avanzada de parámetros y
                    conectividad</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="background: #2ecc71; color: white;" onclick="saveAllConfig()"><i
                        class="fas fa-save"></i> Guardar Cambios</button>
                <button class="btn" style="background: #ecf0f1; color: #7f8c8d;" onclick="checkSystemHealth()"><i
                        class="fas fa-plug"></i> Probar Conexiones</button>
                <button class="btn" style="background: #3498db; color: white;" onclick="createBackup()"><i
                        class="fas fa-database"></i> Respaldar Config</button>
                <button class="btn" style="background: #f1c40f; color: black;" onclick="clearCache()"><i
                        class="fas fa-undo"></i> Restaurar Valores</button>
            </div>
        </div>

        <div class="glass fade-in" style="padding: 0; overflow: hidden; border-radius: 12px;">
            <div class="config-tabs"
                style="display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1);">
                <div class="config-tab active" onclick="showTab('general')"
                    style="padding: 15px 25px; cursor: pointer; border-bottom: 2px solid transparent;">General</div>
                <div class="config-tab" onclick="showTab('sheets')"
                    style="padding: 15px 25px; cursor: pointer; border-bottom: 2px solid transparent;">Google Sheets
                </div>
                <div class="config-tab" id="tab-params-btn" onclick="showTab('params')"
                    style="padding: 15px 25px; cursor: pointer; border-bottom: 2px solid transparent;">Parámetros Cloud
                </div>
                <div class="config-tab" onclick="showTab('backup')"
                    style="padding: 15px 25px; cursor: pointer; border-bottom: 2px solid transparent;">Backup</div>
                <div class="config-tab" onclick="showTab('export')"
                    style="padding: 15px 25px; cursor: pointer; border-bottom: 2px solid transparent;">Exportación</div>
                <div class="config-tab" onclick="showTab('notif')"
                    style="padding: 15px 25px; cursor: pointer; border-bottom: 2px solid transparent;">Notificaciones
                </div>
                <div class="config-tab" onclick="showTab('maint')"
                    style="padding: 15px 25px; cursor: pointer; border-bottom: 2px solid transparent;">Mantenimiento
                </div>
            </div>

            <div style="padding: 30px;">
                <!-- General Section -->
                <div id="general" class="config-section active">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-cog"></i> Configuración General del Sistema</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div class="form-group">
                            <label>Nombre del Sistema</label>
                            <input type="text" id="config-sys-name" value="SIBIM - Sistema de Inventario Municipal"
                                class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Período Actual</label>
                            <input type="text" id="config-period" value="2024-2027" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Organización</label>
                            <input type="text" id="config-org" value="Gobierno Municipal" class="form-control">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div class="form-group">
                            <label>Logo del Sistema (URL)</label>
                            <input type="text" id="config-logo-url" value="../assets/images/logo_municipio.png"
                                class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Tema de Color</label>
                            <select id="config-theme" class="form-control" onchange="Auth.applyTheme(this.value)">
                                <option value="blue">Azul Principal (Default)</option>
                                <option value="green">Verde Corporativo</option>
                                <option value="dark">Modo Oscuro</option>
                                <option value="light">Modo Claro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Idioma</label>
                            <select id="config-lang" class="form-control">
                                <option value="es">Español</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Google Sheets Section -->
                <div id="sheets" class="config-section" style="display: none;">
                    <h3 style="margin-bottom: 20px;"><i class="fab fa-google-drive"></i> Configuración de Conectividad
                        Cloud</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Nombre de la Hoja de Cálculo</label>
                            <input type="text" id="sheet-name-display" value="SIBIM_TZOMPANTEPEC_DB"
                                class="form-control">
                        </div>
                        <div class="form-group">
                            <label>API Key de Google Cloud</label>
                            <input type="password" id="config-api-key" placeholder="AIzaSy..." class="form-control">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>URL del Script de Google (Endpoint API)</label>
                        <input type="text" id="config-script-url" class="form-control"
                            style="font-family: monospace; font-size: 0.85rem;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>ID de la Hoja de Cálculo</label>
                            <input type="text" id="config-sheet-id" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Status de Conexión</label>
                            <div id="conn-status"
                                style="padding: 10px; border-radius: 6px; background: rgba(46, 204, 113, 0.1); color: #2ecc71; border: 1px solid #2ecc71;">
                                <i class="fas fa-check-circle"></i> Sincronizado con Cloud
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parameters Section (NEW) -->
                <div id="params" class="config-section" style="display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3><i class="fas fa-list-ul"></i> Parámetros de Configuración Cloud</h3>
                        <button class="btn btn-outline" onclick="loadCloudConfig()"><i class="fas fa-sync"></i>
                            Recargar</button>
                    </div>
                    <div class="glass" style="padding: 0; overflow-x: auto; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead style="background: rgba(255,255,255,0.05);">
                                <tr>
                                    <th style="padding: 12px; text-align: left;">Clave</th>
                                    <th style="padding: 12px; text-align: left;">Valor</th>
                                    <th style="padding: 12px; text-align: left;">Descripción</th>
                                    <th style="padding: 12px; text-align: left;">Tipo</th>
                                    <th style="padding: 12px; text-align: left;">Módulo</th>
                                    <th style="padding: 12px; text-align: center;">Última Modif.</th>
                                </tr>
                            </thead>
                            <tbody id="params-table-body">
                                <tr>
                                    <td colspan="6"
                                        style="padding: 30px; text-align: center; color: var(--text-secondary);">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando parámetros maestros...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Backup Section -->
                <div id="backup" class="config-section" style="display: none;">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-database"></i> Gestión de Respaldos</h3>
                    <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                        <div class="glass" style="flex: 1; padding: 20px; border-top: 3px solid var(--accent-blue);">
                            <div style="font-weight: bold; margin-bottom: 15px;">Respaldo Automático</div>
                            <div class="form-group">
                                <label class="switch">
                                    <input type="checkbox" checked>
                                    <span class="slider round"></span>
                                    <span> Activar backups diarios</span>
                                </label>
                            </div>
                        </div>
                        <div class="glass" style="flex: 1; padding: 20px; border-top: 3px solid #f1c40f;">
                            <div style="font-weight: bold; margin-bottom: 15px;">Historial de Versiones</div>
                            <p style="font-size: 0.8rem; color: #7f8c8d;">Último respaldo: Hoy 10:45 AM</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="createBackup()"><i class="fas fa-download"></i> Descargar
                        Respaldo JSON Completo</button>
                </div>

                <!-- Export Section -->
                <div id="export" class="config-section" style="display: none;">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-file-export"></i> Preferencias de Exportación</h3>
                    <div class="form-group">
                        <label>Formato Predeterminado de Reportes</label>
                        <select class="form-control">
                            <option>PDF (Alta Calidad)</option>
                            <option>Excel (Datos Crudos)</option>
                            <option>CSV (Interoperable)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Firma en Reportes PDF</label>
                        <input type="text" placeholder="Ej: Dirección de Patrimonio Municipal" class="form-control">
                    </div>
                </div>

                <!-- Notif Section -->
                <div id="notif" class="config-section" style="display: none;">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-bell"></i> Notificaciones y Alertas</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="glass" style="padding: 15px; display: flex; justify-content: space-between;">
                            <span>Alertar sobre bienes próximos a depreciación</span>
                            <input type="checkbox" checked>
                        </div>
                        <div class="glass" style="padding: 15px; display: flex; justify-content: space-between;">
                            <span>Notificar bajas de inventario por email</span>
                            <input type="checkbox">
                        </div>
                    </div>
                </div>

                <!-- Maint Section -->
                <div id="maint" class="config-section" style="display: none;">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-tools"></i> Mantenimiento del Sistema</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <button class="btn glass" style="text-align: left; padding: 20px;">
                            <i class="fas fa-trash-alt" style="color: #e74c3c;"></i> Purgar Logs del Sistema
                        </button>
                        <button class="btn glass" style="text-align: left; padding: 20px;">
                            <i class="fas fa-sync" style="color: #3498db;"></i> Re-indexar Base de Datos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            Auth.checkAccess();
            Auth.initTheme();

            // Populate fields from CONFIG
            document.getElementById('config-script-url').value = CONFIG.scriptUrl;
            document.getElementById('config-sheet-id').value = CONFIG.spreadsheetId;
        });

        function showTab(tabId) {
            document.querySelectorAll('.config-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.config-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(tabId).style.display = 'block';
            event.currentTarget.classList.add('active');

            if (tabId === 'params') loadCloudConfig();
        }

        async function loadCloudConfig() {
            const tbody = document.getElementById('params-table-body');
            try {
                const configItems = await API.getSystemConfig();
                renderCloudConfig(configItems);
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Error al conectar con la base de datos cloud.</td></tr>`;
            }
        }

        function renderCloudConfig(items) {
            const tbody = document.getElementById('params-table-body');
            if (!items || items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron parámetros definidos.</td></tr>`;
                return;
            }

            tbody.innerHTML = items.map(i => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px 12px; font-weight: bold; color: var(--accent-blue);">${i.Clave || i.clave || '---'}</td>
                    <td style="padding: 10px 12px;">${i.Valor || i.valor || '---'}</td>
                    <td style="padding: 10px 12px; font-size: 0.75rem; color: var(--text-secondary);">${i.Descripcion || i.descripcion || '---'}</td>
                    <td style="padding: 10px 12px;"><span class="badge" style="background: rgba(255,255,255,0.1); font-size: 0.7rem;">${i.Tipo || 'STRING'}</span></td>
                    <td style="padding: 10px 12px;">${i.Modulo || 'GENERAL'}</td>
                    <td style="padding: 10px 12px; text-align: center; font-size: 0.75rem;">
                        <div>${i['Ultima Modificacion'] || i.fecha || '---'}</div>
                        <div style="font-size: 0.65rem; color: var(--text-secondary);">${i['Usuario Modificacion'] || ''}</div>
                    </td>
                </tr>
            `).join('');
        }

        function saveAllConfig() {
            alert("Configuración enviada al servidor cloud... \nStatus: Sincronización exitosa.");
        }

        function checkSystemHealth() {
            alert("Diagnosticando conexiones... \n- Google API: OK \n- Latencia: 120ms \n- Permisos: Administrador");
        }

        function clearCache() {
            if (confirm("¿Limpiar caché y cerrar sesión?")) {
                localStorage.clear();
                window.location.href = '../login.html';
            }
        }

        async function createBackup() {
            const items = await API.fetchItems();
            const blob = new Blob([JSON.stringify(items)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'respaldo_inventario.json';
            a.click();
        }
    </script>
</body>

</html>