<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronización Cloud - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sync-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .sync-status-icon {
            font-size: 5rem;
            color: var(--accent-blue);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .sync-status-icon.syncing {
            animation: spin 2s linear infinite;
            color: #2ecc71;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 2px;
        }

        .log-info {
            color: #3498db;
        }

        .log-success {
            color: #2ecc71;
        }

        .log-warning {
            color: #f1c40f;
        }

        .log-error {
            color: #e74c3c;
        }
    </style>
</head>

<body class="theme-dark">
    <header>
        <div class="logo">
            <img src="../assets/images/logo_municipio.png" style="height: 40px; width: auto; margin-right: 10px;">
            <span>SIBIMTZOMP</span>
        </div>
        <div>
            <a href="../index.html" class="btn btn-outline">Volver al Dashboard</a>
        </div>
    </header>

    <main style="padding: 30px 5%;">
        <div class="sync-container glass fade-in" style="padding: 50px;">
            <i id="sync-icon" class="fas fa-sync-alt sync-status-icon"></i>
            <h1 id="sync-title">Sincronización del Sistema</h1>
            <p id="sync-status-text" style="color: var(--text-secondary); margin-bottom: 30px;">Conexión establecida con
                Google Cloud</p>

            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px;">
                <button class="btn" style="background: #2ecc71; color: white;" onclick="startSync()">
                    <i class="fas fa-play"></i> Sincronización Forzada
                </button>
                <button class="btn glass" onclick="checkConnectivity()">
                    <i class="fas fa-wifi"></i> Probar Conectividad
                </button>
                <button class="btn glass" onclick="clearLocalCache()" style="border-color: #e74c3c; color: #e74c3c;">
                    <i class="fas fa-eraser"></i> Limpiar Caché Local
                </button>
            </div>

            <div class="log-container" id="sync-log">
                <div class="log-entry log-info">[SYSTEM] Inicializando módulo de comunicación...</div>
                <div class="log-entry log-info">[AUTH] Verificando credenciales de administrador...</div>
                <div class="log-entry log-success">[AUTH] Token de sesión activo.</div>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            Auth.checkAccess();
            Auth.initTheme();
            addLog("Módulo de sincronización r1.0 listo.", "info");
        });

        function addLog(msg, type = 'info') {
            const log = document.getElementById('sync-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.prepend(entry);
        }

        async function startSync() {
            const icon = document.getElementById('sync-icon');
            const title = document.getElementById('sync-title');
            const statusText = document.getElementById('sync-status-text');

            icon.classList.add('syncing');
            title.textContent = "Sincronizando Datos...";
            addLog("Iniciando purga de caché local...", "warning");

            try {
                localStorage.removeItem('sibim_inventory_cache');
                localStorage.removeItem('sibim_cache_timestamp');
                addLog("Caché local purgado. Consultando Google Sheets API...", "info");

                const items = await API.fetchItems();
                addLog(`Éxito: ${items.length} registros recuperados y cacheados.`, "success");

                statusText.textContent = "Última sincronización: Hoy, " + new Date().toLocaleTimeString();
                title.textContent = "Sincronización Exitosa";
            } catch (err) {
                addLog(`Error crítico: ${err.message}`, "error");
                title.textContent = "Error de Sincronización";
            } finally {
                icon.classList.remove('syncing');
            }
        }

        async function checkConnectivity() {
            addLog("Probando latencia con scriptURL...", "info");
            const start = Date.now();
            try {
                const response = await fetch(CONFIG.scriptUrl + "?action=ping");
                const end = Date.now();
                addLog(`Conectividad OK. Latencia: ${end - start}ms`, "success");
            } catch (err) {
                addLog("Falla de conexión: Probable error de CORS o URL inválida.", "error");
            }
        }

        function clearLocalCache() {
            if (confirm("¿Seguro que desea limpiar el caché local? Esto obligará a una nueva descarga completa.")) {
                localStorage.clear();
                addLog("Memoria local del navegador limpiada totalmente.", "warning");
                setTimeout(() => location.reload(), 1000);
            }
        }
    </script>
</body>

</html>