<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner QR/Barcodes - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--accent-blue) !important;
            background: #000;
        }

        #reader__dashboard_section_csr button {
            background: var(--accent-blue) !important;
            color: white !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 10px !important;
            cursor: pointer !important;
            margin: 10px !important;
        }
    </style>
</head>

<body>
    <header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 5%; height: 80px;">
        <div class="logo" style="display: flex; align-items: center; gap: 15px;">
            <img src="../assets/images/logo_municipio.png" style="height: 60px;">
            <span style="font-weight: 800; color: #00d2ff;">SIBIMTZOMP</span>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="../index.html" class="btn btn-outline" style="padding: 8px 20px; border-radius: 50px;">Volver</a>
            <button onclick="Auth.logout()" class="btn"
                style="background: rgba(231, 76, 60, 0.2); color: #e74c3c; padding: 8px 20px; border-radius: 50px;">Salir</button>
        </div>
    </header>

    <main style="padding: 40px 5%;">
        <div class="glass fade-in" style="padding: 30px; text-align: center;">
            <h2>Escanear QR y Códigos de Barras</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Centra el código en el área marcada para
                identificar el bien.</p>

            <div id="reader"></div>

            <div id="result" class="glass neon-border-blue" style="display: none; margin-top: 30px; padding: 20px;">
                <h3>Resultado del Escaneo</h3>
                <div id="scanned-content">
                    <p id="scanned-code" style="font-size: 1.5rem; color: var(--accent-blue); margin: 15px 0;"></p>
                </div>
                <button id="view-details-btn" class="btn btn-primary" style="margin-top: 20px;">Ver Detalles</button>
                <button class="btn glass" onclick="location.reload()" style="margin-top: 10px; width: 100%;">Escanear
                    Otro</button>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Instanciar el escáner directamente para mayor control sobre formatos específicos
        const html5QrCode = new Html5Qrcode("reader");

        const qrConfig = {
            fps: 20,
            qrbox: { width: 320, height: 180 }, // RECTANGULAR para códigos de barras
            aspectRatio: 1.0,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            },
            // Soporte explícito para formatos comunes de códigos de barras
            formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8
            ]
        };

        // Comenzar el escaneo con soporte EXPLÍCITO para formatos de barras
        html5QrCode.start(
            { facingMode: "environment" },
            qrConfig,
            (decodedText, decodedResult) => {
                onScanSuccess(decodedText, decodedResult);
                html5QrCode.stop().catch(err => console.log("Finalización limpia", err));
            },
            () => { } // Ignorar fallos continuos de detección
        ).catch(err => {
            console.error("Error al iniciar cámara:", err);
            document.getElementById('reader').innerHTML = `<p style="padding: 20px; color: #ff4d4d;">Error al acceder a la cámara. Asegúrese de dar permisos.</p>`;
        });

        async function onScanSuccess(decodedText, decodedResult) {
            const resultDiv = document.getElementById('result');
            const scannedCodeElem = document.getElementById('scanned-code');

            resultDiv.style.display = 'block';
            scannedCodeElem.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando artículo...';

            try {
                const item = await API.getItemById(decodedText);

                if (item) {
                    scannedCodeElem.innerHTML = `
                        <div style="text-align: left; font-size: 1rem; color: white; margin-top: 15px;">
                            <p style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; color: var(--accent-blue); font-weight: bold;">ARTÍCULO ENCONTRADO</p>
                            <p><strong>Descripción:</strong> ${item.nombre || item.Nombre || item.descripcion}</p>
                            <p><strong>Código:</strong> ${item.codigo || item.Codigo || item.id || decodedText}</p>
                            <p><strong>Estado:</strong> ${item.estado || item.Estado || 'Activo'}</p>
                            <p><strong>Depto:</strong> ${item.departamento || item.Departamento || '---'}</p>
                        </div>
                    `;
                    document.getElementById('view-details-btn').innerText = "Abrir en Sistema";
                    document.getElementById('view-details-btn').style.display = 'block';
                    document.getElementById('view-details-btn').onclick = () => {
                        window.location.href = '../index.html?scan=' + encodeURIComponent(decodedText);
                    };
                } else {
                    scannedCodeElem.innerHTML = `
                        <div style="text-align: center; margin-top: 15px;">
                            <p style="color: #00d2ff; font-weight: 800; font-size: 1.2rem;">${decodedText}</p>
                            <p style="color: #ff4d4d; font-size: 0.9rem;">El código no está registrado en el inventario.</p>
                        </div>
                    `;
                    document.getElementById('view-details-btn').style.display = 'none';
                }
            } catch (error) {
                scannedCodeElem.innerHTML = '<p style="color: red;">Error al consultar la base de datos.</p>';
            }
        }
    </script>
</body>

</html>