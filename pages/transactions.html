<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos y Transacciones - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css?v=2.1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .transaction-table th {
            background: rgba(255, 255, 255, 0.05);
            color: #5dade2;
            text-align: left;
            padding: 15px;
            font-weight: 600;
        }

        .transaction-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .badge-type {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-asignacion {
            background: rgba(52, 152, 219, 0.2);
            color: #5dade2;
        }

        .badge-mantenimiento {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .badge-baja {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .badge-traslado {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .badge-creacion {
            background: rgba(52, 152, 219, 0.2);
            color: #5dade2;
        }

        .btn-action {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-asignacion {
            background: #3498db;
        }

        .btn-mantenimiento {
            background: #f39c12;
        }

        .btn-baja {
            background: #e74c3c;
        }

        .btn-traslado {
            background: #2ecc71;
        }

        .btn-action:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        /* Modal specific styles */
        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
    </style>
</head>

<body class="theme-dark">
    <header style="height: 100px; display: flex; justify-content: space-between; align-items: center; padding: 0 5%;">
        <div class="logo" style="display: flex; align-items: center; gap: 20px;">
            <img src="../assets/images/logo_municipio.png" style="height: 60px;">
            <span style="font-size: 1.5rem; font-weight: 800; color: white;">Movimientos y Transacciones</span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="../index.html" class="btn btn-outline"
                style="border-radius: 50px; padding: 8px 25px; border-color: #00d2ff; color: #00d2ff;">VOLVER</a>
            <button onclick="Auth.logout()" class="btn"
                style="background: rgba(231, 76, 60, 0.2); color: #e74c3c; border-radius: 50px; padding: 8px 25px;">SALIR</button>
        </div>
    </header>

    <main style="padding: 20px 5%;">
        <!-- Action Buttons Section -->
        <div style="display: flex; gap: 15px; margin-bottom: 30px; align-items: center; flex-wrap: wrap;">
            <button class="btn-action btn-asignacion" onclick="openMovementModal('ASIGNACIÓN DE RESPONSABLE')">
                <i class="fas fa-user-check"></i> Asignación
            </button>
            <button class="btn-action btn-mantenimiento" onclick="openMovementModal('REGISTRO DE MANTENIMIENTO')">
                <i class="fas fa-tools"></i> Mantenimiento
            </button>
            <button class="btn-action btn-baja" onclick="openMovementModal('BAJA DE ARTÍCULO')">
                <i class="fas fa-trash-alt"></i> Baja
            </button>
            <button class="btn-action btn-traslado" onclick="openMovementModal('TRASLADO ENTRE DEPARTAMENTOS')">
                <i class="fas fa-truck"></i> Traslado
            </button>

            <div style="flex: 1; min-width: 250px; position: relative; margin-left: 20px;">
                <input type="text" id="transaction-search" class="glass"
                    placeholder="Buscar transacción (Código, Tipo, Usuario)..."
                    style="width: 100%; padding: 12px 15px 12px 45px; border-radius: 12px; color: white;"
                    onkeyup="filterTransactions()">
                <i class="fas fa-search"
                    style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--accent-blue);"></i>
            </div>

            <button class="btn" onclick="exportTransactions()"
                style="background: #27ae60; color: white; padding: 12px 25px; border-radius: 12px; font-weight: bold;">
                <i class="fas fa-file-excel"></i> EXPORTAR
            </button>
        </div>

        <!-- Transactions Table -->
        <div class="glass" style="padding: 0; overflow-x: auto; border-radius: 12px;">
            <table class="transaction-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Código Artículo</th>
                        <th>Artículo</th>
                        <th>Tipo</th>
                        <th>Origen</th>
                        <th>Destino</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="transaction-body">
                    <!-- Data will be injected here -->
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-spinner fa-spin"></i> Cargando movimientos...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal para Registrar Movimiento -->
    <div id="movement-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div class="glass" style="width: 500px; padding: 30px; border-radius: 20px; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="color: white; font-size: 1.5rem;"><i class="fas fa-exchange-alt"></i> Registrar Movimiento
                </h2>
                <i class="fas fa-times" onclick="closeModal()" style="cursor: pointer; opacity: 0.5;"></i>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipo de Movimiento:</label>
                    <input type="text" id="m-type" class="glass" readonly
                        style="width: 100%; padding: 12px; color: white; background: rgba(255,255,255,0.05);">
                </div>
                <div class="form-group">
                    <label>Seleccionar Artículo:</label>
                    <select id="m-item" class="glass"
                        style="width: 100%; padding: 12px; color: white; background: #1a2639;">
                        <option value="">Seleccionar artículo</option>
                    </select>
                </div>

                <!-- Campos condicionales para Traslado -->
                <div id="traslado-fields" style="display: none; gap: 15px; flex-direction: column;">
                    <div class="form-group">
                        <label>Departamento de Origen:</label>
                        <select id="m-origin" class="glass"
                            style="width: 100%; padding: 12px; color: white; background: #1a2639;">
                            <option value="">Seleccionar departamento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Departamento de Destino:</label>
                        <select id="m-destination" class="glass"
                            style="width: 100%; padding: 12px; color: white; background: #1a2639;">
                            <option value="">Seleccionar departamento</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="m-observations" class="glass" placeholder="Detalles del movimiento..."
                        style="width: 100%; padding: 12px; height: 100px; color: white;"></textarea>
                </div>
            </div>
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="registerMovement()">
                    <i class="fas fa-save"></i> Registrar Movimiento
                </button>
                <button class="btn" style="background: rgba(255,255,255,0.1); color: white;" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="../js/config.js?v=2.1.0"></script>
    <script src="../js/api.js?v=2.1.0"></script>
    <script src="../js/auth.js?v=2.1.0"></script>
    <script src="../js/app.js?v=2.1.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            Auth.checkAccess();
            Auth.initTheme();
            loadTransactions();
            populateSelectors();
        });

        let allMovements = [];

        async function loadTransactions() {
            const tbody = document.getElementById('transaction-body');
            try {
                allMovements = await API.getMovements();
                renderTransactions(allMovements);
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar datos.</td></tr>';
            }
        }

        function renderTransactions(data) {
            const tbody = document.getElementById('transaction-body');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No hay movimientos registrados.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(m => `
                <tr>
                    <td style="font-weight: bold; color: #5dade2;">${m.ID || m.id || '---'}</td>
                    <td style="font-family: monospace;">${m.CodigoArticulo || m['ID Registro'] || 'TZ-000'}</td>
                    <td>${m.Articulo || m.Detalles || 'Sin Nombre'}</td>
                    <td>
                        <span class="badge-type ${getBadgeClass(m.Tipo || m.tipo)}">
                            <i class="${getIcon(m.Tipo || m.tipo)}"></i> ${m.Tipo || m.tipo || 'MOV'}
                        </span>
                    </td>
                    <td>${m.Origen || '---'}</td>
                    <td>${m.Destino || '---'}</td>
                    <td>${m.Fecha || m.fecha || '---'}</td>
                </tr>
            `).reverse().join('');
        }

        function filterTransactions() {
            const query = document.getElementById('transaction-search').value.toLowerCase().trim();
            if (!query) {
                renderTransactions(allMovements);
                return;
            }

            const filtered = allMovements.filter(m => {
                const code = String(m.CodigoArticulo || m['ID Registro'] || '').toLowerCase();
                const art = String(m.Articulo || m.Detalles || '').toLowerCase();
                const type = String(m.Tipo || m.tipo || '').toLowerCase();
                const user = String(m.Usuario || m.usuario || '').toLowerCase();

                return code.includes(query) || art.includes(query) || type.includes(query) || user.includes(query);
            });

            renderTransactions(filtered);
        }

        function exportTransactions() {
            const query = document.getElementById('transaction-search').value.toLowerCase().trim();
            const dataToExport = query ? allMovements.filter(m => {
                const code = String(m.CodigoArticulo || m['ID Registro'] || '').toLowerCase();
                const art = String(m.Articulo || m.Detalles || '').toLowerCase();
                return code.includes(query) || art.includes(query);
            }) : allMovements;

            if (dataToExport.length === 0) return UI.showToast("No hay registros para exportar", "warning");

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Transacciones");
            XLSX.writeFile(workbook, `Transacciones_SIBIM_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function getBadgeClass(type) {
            if (!type) return 'badge-asignacion';
            const t = type.toLowerCase();
            if (t.includes('asigna')) return 'badge-asignacion';
            if (t.includes('manten')) return 'badge-mantenimiento';
            if (t.includes('baja')) return 'badge-baja';
            if (t.includes('traslado')) return 'badge-traslado';
            if (t.includes('creacion')) return 'badge-creacion';
            return 'badge-asignacion';
        }

        function getIcon(type) {
            if (!type) return 'fas fa-exchange-alt';
            const t = type.toLowerCase();
            if (t.includes('asigna')) return 'fas fa-user-check';
            if (t.includes('manten')) return 'fas fa-tools';
            if (t.includes('baja')) return 'fas fa-trash-alt';
            if (t.includes('traslado')) return 'fas fa-truck';
            if (t.includes('creacion')) return 'fas fa-sync';
            return 'fas fa-exchange-alt';
        }

        async function populateSelectors() {
            try {
                const items = await API.fetchItems();
                const itemSelect = document.getElementById('m-item');
                items.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i.ID || i.Codigo;
                    opt.textContent = `${i.ID || i.Codigo} - ${i.Nombre || i.nombre}`;
                    itemSelect.appendChild(opt);
                });

                const depts = await API.getDepartments();
                const originSelect = document.getElementById('m-origin');
                const destSelect = document.getElementById('m-destination');
                depts.forEach(d => {
                    const name = d.Nombre || d['Nombre Departamento'];
                    const opt1 = document.createElement('option');
                    opt1.value = name; opt1.textContent = name;
                    originSelect.appendChild(opt1);
                    const opt2 = document.createElement('option');
                    opt2.value = name; opt2.textContent = name;
                    destSelect.appendChild(opt2);
                });
            } catch (err) {
                console.error("Error populating selectors", err);
            }
        }

        function openMovementModal(type) {
            document.getElementById('m-type').value = type;
            document.getElementById('traslado-fields').style.display = type.includes('TRASLADO') ? 'flex' : 'none';
            document.getElementById('movement-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('movement-modal').style.display = 'none';
        }

        async function registerMovement() {
            const type = document.getElementById('m-type').value;
            const itemId = document.getElementById('m-item').value;
            const observations = document.getElementById('m-observations').value;
            const origin = document.getElementById('m-origin').value;
            const dest = document.getElementById('m-destination').value;

            if (!itemId) {
                UI.showToast("Debes seleccionar un artículo", "error");
                return;
            }

            try {
                UI.showToast("Registrando movimiento...", "info");

                const user = Auth.getCurrentUser();
                const movementData = {
                    tipo: type,
                    itemId: itemId,
                    usuario: user ? user.username : 'Sistema',
                    detalles: observations,
                    origen: type.includes('TRASLADO') ? origin : '---',
                    destino: type.includes('TRASLADO') ? dest : '---'
                };

                const result = await API.registerMovement(movementData);

                if (result.success) {
                    UI.showToast("Movimiento registrado con éxito", "success");
                    closeModal();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error("Error en la respuesta del servidor");
                }
            } catch (err) {
                console.error("Error registering movement", err);
                UI.showToast("Error al registrar movimiento", "error");
            }
        }
    </script>
</body>

</html>