<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Estadísticas - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css?v=2.1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        @media print {
            @page {
                size: letter;
                margin: 1.5cm;
            }

            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
            }

            .official-page {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .glass {
                border: none !important;
                background: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
            }
        }

        .official-page {
            max-width: 1000px;
            margin: 40px auto;
            background: white;
            color: #333;
            padding: 50px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .letterhead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #00d2ff;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .letterhead-header img {
            height: 90px;
        }

        .report-title {
            text-align: center;
            text-transform: uppercase;
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #1a1a1a;
            font-weight: 800;
        }

        .official-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .official-table th,
        .official-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.8rem;
        }

        .official-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-box .number {
            font-size: 2rem;
            font-weight: 800;
            color: #00d2ff;
        }

        .stat-box .label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            text-transform: uppercase;
        }
    </style>
</head>

<body class="theme-dark">
    <header class="no-print"
        style="height: 100px; display: flex; justify-content: space-between; align-items: center; padding: 0 5%;">
        <div class="logo" style="display: flex; align-items: center; gap: 20px;">
            <img src="../assets/images/logo_municipio.png" style="height: 70px;"
                onerror="this.src='/assets/images/logo_municipio.png'">
            <span style="font-size: 1.8rem; font-weight: 800; color: #00d2ff; letter-spacing: 2px;">SIBIMTZOMP</span>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <img id="escudo-header" src="../assets/images/escudo.png" style="height: 60px;" alt="Escudo Tzompantepec"
                onerror="console.warn('Escudo no encontrado')">
            <a href="../index.html" class="btn btn-outline"
                style="border-radius: 50px; padding: 10px 30px; font-weight: bold; border-color: #00d2ff; color: #00d2ff;">VOLVER</a>
            <button onclick="Auth.logout()" class="btn"
                style="background: rgba(231, 76, 60, 0.2); color: #e74c3c; border-radius: 50px; padding: 10px 30px; font-weight: bold;">SALIR</button>
        </div>
    </header>

    <!-- Page Title Center -->
    <div class="no-print" style="text-align: center; padding: 20px 0; margin-top: 10px;">
        <h1
            style="color: #00d2ff; font-size: 3rem; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; line-height: 1.1;">
            Reportes y Estadísticas
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem; opacity: 0.7;">Gestión integral de reportes
            institucionales y análisis patrimonial.</p>
    </div>

    <main class="no-print" style="padding: 20px 5%;">
        <!-- Botones de Generación de Reportes -->
        <div class="glass" style="padding: 30px; border-radius: 20px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="color: #00d2ff; font-size: 1.3rem;">
                    <i class="fas fa-file-alt"></i> GENERAR REPORTES PROFESIONALES
                </h3>
                <div id="export-controls" style="display: none; gap: 10px;">
                    <button class="btn" onclick="exportFormat('PDF')" style="background: #e74c3c; color: white;">
                        <i class="fas fa-file-pdf"></i> DESCARGAR PDF
                    </button>
                    <button class="btn" onclick="exportFormat('Excel')" style="background: #27ae60; color: white;">
                        <i class="fas fa-file-excel"></i> DESCARGAR EXCEL
                    </button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <button class="btn" style="background: #3498db; color: white; padding: 15px; font-weight: bold;"
                    onclick="generateProfessionalReport('Inventario')">
                    <i class="fas fa-boxes"></i> INVENTARIO GENERAL
                </button>
                <button class="btn" style="background: #2ecc71; color: white; padding: 15px; font-weight: bold;"
                    onclick="generateProfessionalReport('Movimientos')">
                    <i class="fas fa-history"></i> MOVIMIENTOS
                </button>
                <button class="btn" style="background: #f39c12; color: white; padding: 15px; font-weight: bold;"
                    onclick="generateProfessionalReport('Departamentos')">
                    <i class="fas fa-building"></i> POR DEPARTAMENTOS
                </button>
                <button class="btn" style="background: #9b59b6; color: white; padding: 15px; font-weight: bold;"
                    onclick="generateProfessionalReport('Estado')">
                    <i class="fas fa-tasks"></i> POR ESTADO
                </button>
                <button class="btn" style="background: #e74c3c; color: white; padding: 15px; font-weight: bold;"
                    onclick="generateProfessionalReport('Mantenimiento')">
                    <i class="fas fa-tools"></i> MANTENIMIENTO
                </button>
                <button class="btn" style="background: #1abc9c; color: white; padding: 15px; font-weight: bold;"
                    onclick="generateProfessionalReport('Resumen')">
                    <i class="fas fa-chart-pie"></i> RESUMEN EJECUTIVO
                </button>
            </div>
        </div>
    </main>

    <!-- Template de Impresión (Oculto) -->
    <div class="official-page" id="printable-report" style="display: none;">
        <div class="letterhead-header">
            <img src="../assets/images/logo_municipio.png">
            <div style="text-align: center; flex: 1;">
                <div style="font-weight: 900; font-size: 1.6rem; color: #1a1a1a; letter-spacing: 1px;">MUNICIPIO DE
                    TZOMPANTEPEC</div>
                <div style="font-size: 0.9rem; letter-spacing: 3px; color: #333; font-weight: 600;">GOBIERNO MUNICIPAL
                    2024 - 2027</div>
                <div style="font-size: 0.7rem; color: #666; margin-top: 5px;">"Tzompantepec: Lugar de los Arcos"</div>
            </div>
            <img src="../assets/images/escudo.png" style="height: 90px;" onerror="this.style.display='none'">
        </div>

        <h2 class="report-title" id="report-title-text">Cargando Reporte...</h2>

        <!-- Resumen Estadístico -->
        <div id="stats-summary" class="stats-summary" style="display: none;"></div>

        <div id="report-meta"
            style="margin-bottom: 25px; padding: 15px; background: #f9f9f9; border-left: 4px solid #00d2ff; display: flex; justify-content: space-between;">
            <div>
                <p style="margin: 0;"><strong>Fecha Emisión:</strong> <span id="current-date">--/--/----</span></p>
                <p style="margin: 5px 0 0 0;"><strong>Responsable:</strong> <span id="report-user">Sistemas C2</span>
                </p>
                <p style="margin: 5px 0 0 0;"><strong>Período:</strong> <span id="report-period">Todos los
                        registros</span></p>
            </div>
            <div style="text-align: right;">
                <p style="margin: 0;"><small>SIBIM v2.1.0</small></p>
                <p style="margin: 5px 0 0 0;"><small id="report-count">0 registros</small></p>
            </div>
        </div>

        <div id="table-container">
            <table class="official-table" id="data-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <!-- Seccion de Firmas -->
        <div id="signature-section"
            style="margin-top: 80px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 40px; text-align: center;">
            <div style="border-top: 1px solid #333; padding-top: 10px;">
                <p style="margin:0; font-weight: bold; font-size: 0.8rem;">ELABORÓ</p>
                <div style="height: 60px;"></div>
                <p style="margin:0; font-size: 0.75rem;"><span id="elaboro-name">__________________________</span></p>
                <p style="margin:0; font-size: 0.65rem; color: #666;">Encargado de Inventarios</p>
            </div>
            <div style="border-top: 1px solid #333; padding-top: 10px;">
                <p style="margin:0; font-weight: bold; font-size: 0.8rem;">REVISÓ</p>
                <div style="height: 60px;"></div>
                <p style="margin:0; font-size: 0.75rem;">__________________________</p>
                <p style="margin:0; font-size: 0.65rem; color: #666;">Director de Área</p>
            </div>
            <div style="border-top: 1px solid #333; padding-top: 10px;">
                <p style="margin:0; font-weight: bold; font-size: 0.8rem;">AUTORIZÓ</p>
                <div style="height: 60px;"></div>
                <p style="margin:0; font-size: 0.75rem;">__________________________</p>
                <p style="margin:0; font-size: 0.65rem; color: #666;">Secretario del Ayuntamiento</p>
            </div>
        </div>

        <div
            style="text-align: center; margin-top: 50px; font-size: 0.7rem; color: #666; border-top: 1px solid #eee; padding-top: 20px;">
            <p>Av. Zaragoza no. 1, San Salvador Tzompantepec, Col. Centro, C.P. 90490 | Tel: 241-4152315</p>
            <p><strong>SIBIM v2.1.0 - SISTEMA INTEGRAL DE BIENES INMUEBLES Y MUEBLES</strong></p>
            <p style="margin-top: 5px; opacity: 0.5;">ID de Validación: <span id="verification-code">---</span></p>
        </div>
    </div>

    <script src="../js/config.js?v=2.1.0"></script>
    <script src="../js/api.js?v=2.1.0"></script>
    <script src="../js/auth.js?v=2.1.0"></script>
    <script src="../js/app.js?v=2.1.0"></script>
    <script>
        let currentReportData = [];
        let currentReportType = '';

        document.addEventListener('DOMContentLoaded', async () => {
            Auth.checkAccess();
            Auth.initTheme();
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const user = Auth.getCurrentUser();
            if (user) {
                document.getElementById('report-user').textContent = user.username.toUpperCase();
                document.getElementById('elaboro-name').textContent = user.username.toUpperCase();
            }
            document.getElementById('verification-code').textContent = Math.random().toString(36).substr(2, 9).toUpperCase();
        });

        async function generateProfessionalReport(type) {
            currentReportType = type;
            const printable = document.getElementById('printable-report');
            const titleElem = document.getElementById('report-title-text');
            const tableBody = document.getElementById('table-body');
            const statsContainer = document.getElementById('stats-summary');

            printable.style.display = 'block';
            titleElem.textContent = `REPORTE PROFESIONAL DE ${type.toUpperCase()}`;
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Generando reporte profesional...</td></tr>';

            try {
                let data, stats;

                if (type === 'Movimientos') {
                    data = await API.getMovements();
                    stats = generateMovementsStats(data);
                } else if (type === 'Resumen') {
                    const allData = await API.getStats();
                    data = allData.items;
                    stats = generateExecutiveSummary(allData);
                } else {
                    const allData = await API.fetchItems();
                    data = filterDataByType(allData, type);
                    stats = generateInventoryStats(data, type);
                }

                currentReportData = data;
                document.getElementById('report-count').textContent = `${data.length} registros`;

                // Mostrar estadísticas
                renderStats(stats, statsContainer);

                // Renderizar tabla
                renderProfessionalTable(data, type);

                // Mostrar controles de exportación
                document.getElementById('export-controls').style.display = 'flex';

                window.scrollTo({ top: printable.offsetTop, behavior: 'smooth' });
                UI.showToast(`Reporte profesional de ${type} generado exitosamente`, "success");
            } catch (err) {
                Logger.error('Error al generar reporte:', err);
                tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; color:red; padding:20px;">Error: ${err.message}</td></tr>`;
                UI.showToast("Error al generar reporte", "error");
            }
        }

        function filterDataByType(data, type) {
            switch (type) {
                case 'Mantenimiento':
                    return data.filter(i => (i.Estado || '').toUpperCase().includes('MANTENIMIENTO'));
                case 'Estado':
                    return data; // Mostrar todos, agrupados por estado
                case 'Departamentos':
                    return data.sort((a, b) => {
                        const deptA = a.Departamento || '';
                        const deptB = b.Departamento || '';
                        return deptA.localeCompare(deptB);
                    });
                default:
                    return data;
            }
        }

        function generateInventoryStats(data, type) {
            const total = data.length;
            const activos = data.filter(i => (i.Estado || '').toUpperCase() === 'ACTIVO').length;
            const mantenimiento = data.filter(i => (i.Estado || '').toUpperCase().includes('MANTENIMIENTO')).length;
            const valorTotal = data.reduce((sum, i) => sum + (parseFloat(i.Valor) || 0), 0);

            const depts = {};
            data.forEach(i => {
                const dept = i.Departamento || 'Sin Asignar';
                depts[dept] = (depts[dept] || 0) + 1;
            });
            const departamentos = Object.keys(depts).length;

            return {
                'Total de Artículos': total,
                'Artículos Activos': activos,
                'En Mantenimiento': mantenimiento,
                'Departamentos': departamentos,
                'Valor Total': `$${valorTotal.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`
            };
        }

        function generateMovementsStats(data) {
            const total = data.length;
            const hoy = new Date();
            const hace7dias = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
            const hace30dias = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);

            const ultimos7dias = data.filter(m => {
                const fecha = new Date(m.Fecha || m.fecha);
                return fecha >= hace7dias;
            }).length;

            const ultimos30dias = data.filter(m => {
                const fecha = new Date(m.Fecha || m.fecha);
                return fecha >= hace30dias;
            }).length;

            const usuarios = new Set(data.map(m => m.Usuario || m.usuario)).size;

            return {
                'Total Movimientos': total,
                'Últimos 7 Días': ultimos7dias,
                'Últimos 30 Días': ultimos30dias,
                'Usuarios Activos': usuarios
            };
        }

        function generateExecutiveSummary(allData) {
            const items = allData.items;
            const stats = allData.stats;

            return {
                'Total Patrimonio': items.length,
                'Departamentos': stats.departamentos,
                'Movimientos Totales': stats.movimientos,
                'Valor Estimado': `$${items.reduce((sum, i) => sum + (parseFloat(i.Valor) || 0), 0).toLocaleString('es-MX')}`
            };
        }

        function renderStats(stats, container) {
            container.style.display = 'grid';
            container.innerHTML = Object.entries(stats).map(([label, value]) => `
                <div class="stat-box">
                    <div class="number">${value}</div>
                    <div class="label">${label}</div>
                </div>
            `).join('');
        }

        function renderProfessionalTable(data, type) {
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');

            let headers, renderRow;

            switch (type) {
                case 'Movimientos':
                    headers = ['#', 'Fecha/Hora', 'Usuario', 'Acción', 'Tipo', 'Artículo/ID', 'Detalles'];
                    renderRow = (m, index) => `
                        <tr>
                            <td style="font-weight:bold;">${index + 1}</td>
                            <td>${m.Fecha || m.fecha || '---'}</td>
                            <td>${m.Usuario || m.usuario || '---'}</td>
                            <td>${m.Accion || m.accion || '---'}</td>
                            <td><span style="padding:3px 8px; border-radius:4px; background:#e8f4f8; font-size:0.7rem; font-weight:bold;">${m.Tipo || m.tipo || '---'}</span></td>
                            <td>${m['ID Registro'] || m.id || '---'}</td>
                            <td style="font-size:0.75rem;">${m.Detalles || m.detalles || '---'}</td>
                        </tr>
                    `;
                    break;

                case 'Departamentos':
                    headers = ['Departamento', 'Código', 'Artículo', 'Responsable', 'Estado', 'Valor (MXN)'];
                    renderRow = (item, index) => `
                        <tr>
                            <td style="font-weight:bold;">${item.Departamento || 'S/A'}</td>
                            <td>${item.Codigo || item.codigo || item.ID || 'S/C'}</td>
                            <td style="text-transform:uppercase;">${item.Nombre || item.nombre || '---'}</td>
                            <td>${item.Responsable || item.responsable || 'S/R'}</td>
                            <td><span style="padding:3px 8px; border-radius:4px; background:#e8f4f8; font-size:0.7rem; font-weight:bold;">${(item.Estado || 'ACTIVO').toUpperCase()}</span></td>
                            <td style="text-align:right;">$${(parseFloat(item.Valor) || 0).toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
                        </tr>
                    `;
                    break;

                case 'Estado':
                    headers = ['Estado', 'Código', 'Artículo', 'Departamento', 'Fecha Adquisición', 'Valor (MXN)'];
                    renderRow = (item, index) => `
                        <tr>
                            <td><span style="padding:3px 8px; border-radius:4px; background:#e8f4f8; font-size:0.7rem; font-weight:bold;">${(item.Estado || 'ACTIVO').toUpperCase()}</span></td>
                            <td>${item.Codigo || item.codigo || item.ID || 'S/C'}</td>
                            <td style="text-transform:uppercase;">${item.Nombre || item.nombre || '---'}</td>
                            <td>${item.Departamento || 'S/A'}</td>
                            <td>${item.Fecha_Adquisicion || item.fecha_adquisicion || '---'}</td>
                            <td style="text-align:right;">$${(parseFloat(item.Valor) || 0).toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
                        </tr>
                    `;
                    break;

                case 'Mantenimiento':
                    headers = ['Código', 'Artículo', 'Departamento', 'Estado', 'Responsable', 'Observaciones'];
                    renderRow = (item, index) => `
                        <tr>
                            <td style="font-weight:bold;">${item.Codigo || item.codigo || item.ID || 'S/C'}</td>
                            <td style="text-transform:uppercase;">${item.Nombre || item.nombre || '---'}</td>
                            <td>${item.Departamento || 'S/A'}</td>
                            <td><span style="padding:3px 8px; border-radius:4px; background:#fff3cd; color:#856404; font-size:0.7rem; font-weight:bold;">${(item.Estado || 'MANTENIMIENTO').toUpperCase()}</span></td>
                            <td>${item.Responsable || 'S/R'}</td>
                            <td style="font-size:0.75rem;">${item.Observaciones || 'Requiere revisión'}</td>
                        </tr>
                    `;
                    break;

                case 'Resumen':
                    headers = ['Categoría', 'Cantidad', 'Valor Total (MXN)', 'Porcentaje'];
                    const summary = {};
                    data.forEach(item => {
                        const cat = item.Categoria || item.categoria || item.Tipo || 'Sin Categoría';
                        if (!summary[cat]) summary[cat] = { count: 0, value: 0 };
                        summary[cat].count++;
                        summary[cat].value += parseFloat(item.Valor) || 0;
                    });
                    const totalValue = Object.values(summary).reduce((sum, s) => sum + s.value, 0);
                    data = Object.entries(summary).map(([cat, stats]) => ({
                        categoria: cat,
                        cantidad: stats.count,
                        valor: stats.value,
                        porcentaje: ((stats.value / totalValue) * 100).toFixed(2)
                    }));
                    renderRow = (item, index) => `
                        <tr>
                            <td style="font-weight:bold;">${item.categoria}</td>
                            <td style="text-align:center;">${item.cantidad}</td>
                            <td style="text-align:right;">$${item.valor.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
                            <td style="text-align:center;">${item.porcentaje}%</td>
                        </tr>
                    `;
                    break;

                default: // Inventario
                    headers = ['#', 'Código', 'Descripción', 'Marca/Modelo', 'Serie', 'Departamento', 'Estado', 'Valor (MXN)'];
                    renderRow = (item, index) => `
                        <tr>
                            <td style="font-weight:bold;">${index + 1}</td>
                            <td>${item.Codigo || item.codigo || item.ID || 'S/C'}</td>
                            <td style="text-transform:uppercase;">${item.Nombre || item.nombre || '---'}</td>
                            <td>${(item.Marca || '') + ' ' + (item.Modelo || '')}</td>
                            <td>${item.Serie || item.serie || 'S/N'}</td>
                            <td>${item.Departamento || 'S/A'}</td>
                            <td><span style="padding:3px 8px; border-radius:4px; background:#e8f4f8; font-size:0.7rem; font-weight:bold;">${(item.Estado || 'ACTIVO').toUpperCase()}</span></td>
                            <td style="text-align:right;">$${(parseFloat(item.Valor) || 0).toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
                        </tr>
                    `;
            }

            tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center; padding:20px;">No se encontraron registros.</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map((item, index) => renderRow(item, index)).join('');
        }

        function exportFormat(format) {
            if (currentReportData.length === 0) {
                alert('Primero genera un reporte');
                return;
            }

            UI.showToast(`Generando ${format}...`, "info");
            if (format === 'PDF') {
                window.print();
            } else if (format === 'Excel') {
                const table = document.getElementById('data-table');
                const wb = XLSX.utils.table_to_book(table, { sheet: "Reporte" });
                XLSX.writeFile(wb, `Reporte_SIBIM_${currentReportType}_${new Date().getTime()}.xlsx`);
            }
        }
    </script>
</body>

</html>