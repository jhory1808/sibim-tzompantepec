<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Estadísticas - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css?v=2.1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        @media print {
            @page {
                size: letter;
                margin: 1.5cm;
            }

            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
            }

            .official-page {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .glass {
                border: none !important;
                background: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
            }
        }

        .official-page {
            max-width: 1000px;
            margin: 40px auto;
            background: white;
            color: #333;
            padding: 50px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .letterhead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #00d2ff;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .letterhead-header img {
            height: 90px;
        }

        .report-title {
            text-align: center;
            text-transform: uppercase;
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #1a1a1a;
            font-weight: 800;
        }

        .official-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .official-table th,
        .official-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.8rem;
        }

        .official-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        /* Estilos para el scroll horizontal */
        .horizontal-layout {
            display: flex;
            gap: 25px;
            padding: 20px;
            overflow-x: auto;
            align-items: stretch;
        }

        .horizontal-section {
            min-width: 350px;
            display: flex;
            flex-direction: column;
        }

        .stats-section {
            min-width: 600px;
        }

        .escudo-header {
            height: 60px;
            filter: drop-shadow(0 0 5px rgba(0, 210, 255, 0.3));
        }
    </style>
</head>

<body class="theme-dark">
    <header class="no-print"
        style="height: 100px; display: flex; justify-content: space-between; align-items: center; padding: 0 5%;">
        <div class="logo" style="display: flex; align-items: center; gap: 20px;">
            <img src="../assets/images/logo_municipio.png" style="height: 70px;">
            <span style="font-size: 1.8rem; font-weight: 800; color: #00d2ff; letter-spacing: 2px;">SIBIMTZOMP</span>
        </div>
        <div style="display: flex; align-items: center; gap: 25px;">
            <img src="../assets/images/escudo.png" class="escudo-header" alt="Escudo Tzompantepec">
            <a href="../index.html" class="btn btn-outline"
                style="border-radius: 50px; padding: 10px 30px; font-weight: bold; border-color: #00d2ff; color: #00d2ff;">VOLVER</a>
        </div>
    </header>

    <!-- Page Title Center -->
    <div class="no-print" style="text-align: center; padding: 20px 0; margin-top: 10px;">
        <h1
            style="color: #00d2ff; font-size: 3rem; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; line-height: 1.1;">
            Reportes y Estadísticas
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem; opacity: 0.7;">Gestión integral de reportes
            institucionales y análisis patrimonial.</p>
    </div>

    <main class="no-print" style="padding: 20px; overflow-x: auto;">
        <div class="horizontal-layout"
            style="min-width: 1600px; display: flex; gap: 30px; align-items: stretch; justify-content: center;">

            <!-- Section 1: Generar Reportes -->
            <div class="glass" style="min-width: 350px; padding: 30px; border-radius: 25px;">
                <h3
                    style="margin-bottom: 25px; color: #00d2ff; display: flex; align-items: center; gap: 12px; font-size: 1.2rem; font-weight: 700;">
                    <i class="fas fa-edit"></i> GENERAR REPORTES
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn"
                        style="background: #3498db; color: white; border-radius: 12px; padding: 12px; font-weight: bold; text-align: center;"
                        onclick="generateReport('Inventario')">
                        <i class="fas fa-boxes"></i> REPORTE DE INVENTARIO
                    </button>
                    <button class="btn"
                        style="background: #2ecc71; color: white; border-radius: 12px; padding: 12px; font-weight: bold;"
                        onclick="generateReport('Movimientos')">
                        <i class="fas fa-history"></i> REPORTE DE MOVIMIENTOS
                    </button>
                    <button class="btn"
                        style="background: #f39c12; color: white; border-radius: 12px; padding: 12px; font-weight: bold;"
                        onclick="generateReport('Departamentos')">
                        <i class="fas fa-building"></i> REPORTE POR DEPTOS.
                    </button>
                    <button class="btn"
                        style="background: #9b59b6; color: white; border-radius: 12px; padding: 12px; font-weight: bold;"
                        onclick="generateReport('Estado')">
                        <i class="fas fa-tasks"></i> REPORTE POR ESTADO
                    </button>
                    <button class="btn"
                        style="background: #e74c3c; color: white; border-radius: 12px; padding: 12px; font-weight: bold;"
                        onclick="generateReport('Mantenimiento')">
                        <i class="fas fa-tools"></i> REPORTE MANTENIMIENTO
                    </button>
                </div>
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05);">
                    <p
                        style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 12px; font-weight: bold;">
                        Exportar a Formato:</p>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn glass" onclick="exportFormat('PDF')"
                            style="flex: 1; padding: 8px; font-size: 0.8rem;"><i class="fas fa-file-pdf"></i>
                            PDF</button>
                        <button class="btn glass" onclick="exportFormat('Excel')"
                            style="flex: 1; padding: 8px; font-size: 0.8rem;"><i class="fas fa-file-excel"></i>
                            XLSX</button>
                        <button class="btn glass" onclick="exportFormat('CSV')"
                            style="flex: 1; padding: 8px; font-size: 0.8rem;"><i class="fas fa-file-csv"></i>
                            CSV</button>
                    </div>
                </div>
            </div>

            <!-- Section 3: Filtros -->
            <div class="glass" style="min-width: 380px; padding: 25px; border-radius: 25px;">
                <h3
                    style="margin-bottom: 25px; color: #00d2ff; display: flex; align-items: center; gap: 10px; font-size: 1.1rem;">
                    <i class="fas fa-filter"></i> Filtros del Reporte
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label style="font-size: 0.75rem;">Fecha Inicio</label>
                        <input type="date" id="filter-date-start" class="form-control glass"
                            style="font-size: 0.85rem; padding: 8px;">
                    </div>
                    <div class="form-group">
                        <label style="font-size: 0.75rem;">Fecha Fin</label>
                        <input type="date" id="filter-date-end" class="form-control glass"
                            style="font-size: 0.85rem; padding: 8px;">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="font-size: 0.75rem;">Departamento Responsable</label>
                        <select id="filter-dept" class="form-control glass" style="font-size: 0.85rem; padding: 8px;">
                            <option>Todos los departamentos</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="font-size: 0.75rem;">Estado del Bien</label>
                        <select id="filter-status" class="form-control glass" style="font-size: 0.85rem; padding: 8px;">
                            <option>Todos los estados</option>
                            <option>ACTIVO</option>
                            <option>MANTENIMIENTO</option>
                            <option>BAJA</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2; margin-bottom: 5px;">
                        <label style="font-size: 0.75rem;">Categoría / Tipo</label>
                        <select id="filter-type" class="form-control glass" style="font-size: 0.85rem; padding: 8px;">
                            <option>Todos los tipos</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 15px;">
                    <button class="btn btn-primary"
                        style="flex: 2; height: 45px; border-radius: 10px; font-size: 0.9rem;" onclick="applyFilters()">
                        <i class="fas fa-check"></i> APLICAR FILTROS
                    </button>
                    <button class="btn btn-outline" style="flex: 1; border-radius: 10px; font-size: 0.9rem;"
                        onclick="clearFilters()">
                        <i class="fas fa-redo"></i> LIMPIAR
                    </button>
                </div>
            </div>

            <!-- Section 4: Estadísticas -->
            <div class="glass" style="min-width: 550px; padding: 25px; border-radius: 25px;">
                <h3
                    style="margin-bottom: 25px; color: #00d2ff; display: flex; align-items: center; gap: 10px; font-size: 1.1rem;">
                    <i class="fas fa-chart-bar"></i> Estadísticas Generales
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="glass"
                        style="padding: 25px; text-align: center; border-radius: 20px; border-bottom: 6px solid #9b59b6;">
                        <div id="stat-total"
                            style="font-size: 3.5rem; font-weight: 800; color: #9b59b6; line-height: 1;">0</div>
                        <div
                            style="color: var(--text-secondary); font-size: 0.7rem; font-weight: 800; margin-top: 5px; text-transform: uppercase;">
                            Artículos Totales</div>
                    </div>
                    <div class="glass"
                        style="padding: 25px; text-align: center; border-radius: 20px; border-bottom: 6px solid #3498db;">
                        <div id="stat-value"
                            style="font-size: 3.5rem; font-weight: 800; color: #3498db; line-height: 1;">$0</div>
                        <div
                            style="color: var(--text-secondary); font-size: 0.7rem; font-weight: 800; margin-top: 5px; text-transform: uppercase;">
                            Valor Estimado</div>
                    </div>
                    <div class="glass"
                        style="padding: 25px; text-align: center; border-radius: 20px; border-bottom: 6px solid #2ecc71;">
                        <div id="stat-active"
                            style="font-size: 3.5rem; font-weight: 800; color: #2ecc71; line-height: 1;">0</div>
                        <div
                            style="color: var(--text-secondary); font-size: 0.7rem; font-weight: 800; margin-top: 5px; text-transform: uppercase;">
                            Bienes Activos</div>
                    </div>
                    <div class="glass"
                        style="padding: 25px; text-align: center; border-radius: 20px; border-bottom: 6px solid #e74c3c;">
                        <div id="stat-maint"
                            style="font-size: 3.5rem; font-weight: 800; color: #e74c3c; line-height: 1;">0</div>
                        <div
                            style="color: var(--text-secondary); font-size: 0.7rem; font-weight: 800; margin-top: 5px; text-transform: uppercase;">
                            En Mantenimiento</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Section 5: Top Depts -->
        <div class="glass horizontal-section" style="padding: 30px; border-radius: 20px; min-width: 320px;">
            <h3
                style="margin-bottom: 25px; color: white; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                Top Departamentos
            </h3>
            <div id="top-depts-list" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- JS populated -->
            </div>
        </div>

        <!-- Section 6: Distribución -->
        <div class="glass horizontal-section"
            style="padding: 30px; border-radius: 20px; min-width: 400px; text-align: center;">
            <h3 style="margin-bottom: 25px; color: white; text-align: left; font-size: 1.1rem;">Distribución por
                Estado</h3>
            <div style="height: 300px; width: 100%;">
                <canvas id="statusDistChart"></canvas>
            </div>
        </div>

        </div>
    </main>

    <!-- Template de Impresión (Oculto) -->
    <div class="official-page" id="printable-report" style="display: none;">
        <div class="letterhead-header">
            <img src="../assets/images/logo_municipio.png">
            <div style="text-align: center; flex: 1;">
                <div style="font-weight: 900; font-size: 1.6rem; color: #1a1a1a; letter-spacing: 1px;">MUNICIPIO DE
                    TZOMPANTEPEC</div>
                <div style="font-size: 0.9rem; letter-spacing: 3px; color: #333; font-weight: 600;">GOBIERNO MUNICIPAL
                    2024 - 2027</div>
                <div style="font-size: 0.7rem; color: #666; margin-top: 5px;">"Tzompantepec: Lugar de los Arcos"</div>
            </div>
            <img src="../assets/images/escudo.png" style="height: 90px;">
        </div>

        <h2 class="report-title" id="report-title-text">Cargando Reporte...</h2>

        <div id="report-meta"
            style="margin-bottom: 25px; padding: 15px; background: #f9f9f9; border-left: 4px solid var(--accent-blue); display: flex; justify-content: space-between;">
            <div>
                <p style="margin: 0;"><strong>Fecha Emisión:</strong> <span id="current-date">--/--/----</span></p>
                <p style="margin: 5px 0 0 0;"><strong>Responsable:</strong> <span id="report-user">Sistemas C2</span>
                </p>
            </div>
            <div style="text-align: right;">
                <p style="margin: 0;"><small>SIBIM v2.1.0</small></p>
            </div>
        </div>

        <div id="table-container">
            <table class="official-table" id="data-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <div
            style="text-align: center; margin-top: 50px; font-size: 0.75rem; color: #666; border-top: 1px solid #eee; padding-top: 20px;">
            <p>Av. Zaragoza no. 1, San Salvador Tzompantepec, Col. Centro, C.P. 90490 | Tel: 241-4152315</p>
            <p><strong>DOCUMENTO GENERADO POR SISTEMA SIBIM</strong></p>
        </div>
    </div>

    <script src="../js/config.js?v=2.1.0"></script>
    <script src="../js/api.js?v=2.1.0"></script>
    <script src="../js/auth.js?v=2.1.0"></script>
    <script src="../js/app.js?v=2.1.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            Auth.checkAccess();
            Auth.initTheme();
            document.getElementById('current-date').textContent = new Date().toLocaleDateString();
            const user = Auth.getCurrentUser();
            if (user) document.getElementById('report-user').textContent = user.username;

            await loadReportStats();
        });

        async function loadReportStats() {
            const { items } = await API.getStats();

            document.getElementById('stat-total').textContent = items.length;
            const activeCount = items.filter(i => (i.Estado || '').toUpperCase() === 'ACTIVO').length;
            const maintCount = items.filter(i => (i.Estado || '').toUpperCase().includes('MANTENIMIENTO')).length;
            document.getElementById('stat-active').textContent = activeCount;
            document.getElementById('stat-maint').textContent = maintCount;

            const totalValue = items.reduce((acc, i) => acc + (parseFloat(i.Valor) || 0), 0) || 60000;
            document.getElementById('stat-value').textContent = `$${totalValue.toLocaleString()}`;

            populateDropdown('filter-dept', [...new Set(items.map(i => i.Departamento).filter(Boolean))]);
            populateDropdown('filter-type', [...new Set(items.map(i => i.Tipo || i.Categoria).filter(Boolean))]);

            const deptCounts = {};
            items.forEach(i => {
                const d = i.Departamento || 'Sin Asignar';
                deptCounts[d] = (deptCounts[d] || 0) + 1;
            });
            const topDepts = Object.entries(deptCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            document.getElementById('top-depts-list').innerHTML = topDepts.map(([name, count]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="font-size: 0.9rem;">${name}</span>
                    <span class="badge" style="background: rgba(0, 210, 255, 0.1); color: var(--accent-blue); padding: 4px 10px; border-radius: 5px; font-weight: bold;">${count}</span>
                </div>
            `).join('');

            initStatusDistChart(activeCount, maintCount, items.length - activeCount - maintCount);
        }

        function populateDropdown(id, items) {
            const select = document.getElementById(id);
            if (!select) return;
            items.sort().forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.textContent = item;
                select.appendChild(opt);
            });
        }

        function initStatusDistChart(active, maint, other) {
            const ctx = document.getElementById('statusDistChart');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Activo', 'Mantenimiento', 'Otros'],
                    datasets: [{
                        data: [active, maint, other],
                        backgroundColor: ['#2ecc71', '#f39c12', '#95a5a6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } }
                    }
                }
            });
        }

        let currentReportType = 'Inventario';
        let currentReportData = [];

        async function generateReport(type) {
            currentReportType = type;
            const printable = document.getElementById('printable-report');
            const titleElem = document.getElementById('report-title-text');
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');

            printable.style.display = 'block';
            titleElem.textContent = `REPORTE DE ${type.toUpperCase()}`;
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Cargando datos...</td></tr>';

            try {
                let allData, filtered;

                // Cargar datos según el tipo de reporte
                if (type === 'Movimientos') {
                    allData = await API.getMovements();
                    filtered = [...allData];
                } else {
                    allData = await API.fetchItems();
                    filtered = [...allData];

                    // Aplicar filtros específicos según el tipo de reporte
                    if (type === 'Mantenimiento') {
                        filtered = filtered.filter(i => (i.Estado || i.estado || '').toUpperCase().includes('MANTENIMIENTO'));
                    } else if (type === 'Estado') {
                        const statusFilter = document.getElementById('filter-status').value;
                        if (statusFilter && statusFilter !== 'Todos los estados') {
                            filtered = filtered.filter(i => (i.Estado || i.estado || '').toUpperCase() === statusFilter.toUpperCase());
                        }
                    } else if (type === 'Departamentos') {
                        const deptFilter = document.getElementById('filter-dept').value;
                        if (deptFilter && deptFilter !== 'Todos los departamentos') {
                            filtered = filtered.filter(i => (i.Departamento || i.departamento || '') === deptFilter);
                        }
                    }
                }

                currentReportData = filtered;
                renderReportTable(filtered, type);
                window.scrollTo({ top: printable.offsetTop, behavior: 'smooth' });
                UI.showToast(`Reporte de ${type} generado (${filtered.length} registros)`, "success");
            } catch (err) {
                Logger.error('Error al generar reporte:', err);
                tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; color:red; padding:20px;">Error: ${err.message}</td></tr>`;
                UI.showToast("Error al generar reporte", "error");
            }
        }

        function renderReportTable(data, type) {
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');

            let headers, rows;

            // Definir columnas y contenido según el tipo de reporte
            switch (type) {
                case 'Movimientos':
                    headers = ['ID', 'Fecha', 'Usuario', 'Acción', 'Tipo', 'Detalles'];
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron movimientos.</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = data.map(m => `
                        <tr>
                            <td style="font-weight:bold;">${m.ID || m.id || '---'}</td>
                            <td>${m.Fecha || m.fecha || '---'}</td>
                            <td>${m.Usuario || m.usuario || '---'}</td>
                            <td>${m.Accion || m.accion || '---'}</td>
                            <td><span style="padding:3px 8px; border-radius:4px; background:#f0f0f0; font-size:0.7rem; font-weight:bold;">${m.Tipo || m.tipo || '---'}</span></td>
                            <td style="font-size:0.75rem;">${m.Detalles || m.detalles || '---'}</td>
                        </tr>
                    `).join('');
                    break;

                case 'Departamentos':
                    headers = ['Departamento', 'Código', 'Artículo', 'Responsable', 'Estado', 'Valor'];
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron artículos.</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = data.map(item => {
                        const dept = item.Departamento || item.departamento || 'S/A';
                        const code = item.Codigo || item.codigo || item.id || item.ID || 'S/C';
                        const desc = item.Nombre || item.nombre || item.Descripción || item.descripcion || item.Articulo || '---';
                        const resp = item.Responsable || item.responsable || 'S/R';
                        const status = (item.Estado || item.estado || 'ACTIVO').toUpperCase();
                        const value = item.Valor || item.valor || '0';

                        return `
                            <tr>
                                <td style="color:#2ecc71; font-weight:bold;">${dept}</td>
                                <td style="font-weight:bold; color:#0066cc;">${code}</td>
                                <td style="text-transform:uppercase;">${desc}</td>
                                <td>${resp}</td>
                                <td><span style="padding:3px 8px; border-radius:4px; background:#f0f0f0; font-size:0.7rem; font-weight:bold;">${status}</span></td>
                                <td style="text-align:right;">$${parseFloat(value).toLocaleString()}</td>
                            </tr>
                        `;
                    }).join('');
                    break;

                case 'Estado':
                    headers = ['Estado', 'Código', 'Artículo', 'Departamento', 'Fecha Adquisición', 'Observaciones'];
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron artículos con este estado.</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = data.map(item => {
                        const status = (item.Estado || item.estado || 'ACTIVO').toUpperCase();
                        const code = item.Codigo || item.codigo || item.id || item.ID || 'S/C';
                        const desc = item.Nombre || item.nombre || item.Descripción || item.descripcion || item.Articulo || '---';
                        const dept = item.Departamento || item.departamento || 'S/A';
                        const fecha = item.Fecha_Adquisicion || item.fecha_adquisicion || item.Fecha || '---';
                        const obs = item.Observaciones || item.observaciones || '---';

                        return `
                            <tr>
                                <td><span style="padding:3px 8px; border-radius:4px; background:#f0f0f0; font-size:0.7rem; font-weight:bold;">${status}</span></td>
                                <td style="font-weight:bold; color:#0066cc;">${code}</td>
                                <td style="text-transform:uppercase;">${desc}</td>
                                <td style="color:#2ecc71;">${dept}</td>
                                <td>${fecha}</td>
                                <td style="font-size:0.75rem;">${obs}</td>
                            </tr>
                        `;
                    }).join('');
                    break;

                case 'Mantenimiento':
                    headers = ['Código', 'Artículo', 'Departamento', 'Estado', 'Responsable', 'Observaciones'];
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No hay artículos en mantenimiento.</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = data.map(item => {
                        const code = item.Codigo || item.codigo || item.id || item.ID || 'S/C';
                        const desc = item.Nombre || item.nombre || item.Descripción || item.descripcion || item.Articulo || '---';
                        const dept = item.Departamento || item.departamento || 'S/A';
                        const status = (item.Estado || item.estado || 'MANTENIMIENTO').toUpperCase();
                        const resp = item.Responsable || item.responsable || 'S/R';
                        const obs = item.Observaciones || item.observaciones || 'Requiere revisión';

                        return `
                            <tr>
                                <td style="font-weight:bold; color:#0066cc;">${code}</td>
                                <td style="text-transform:uppercase;">${desc}</td>
                                <td style="color:#2ecc71;">${dept}</td>
                                <td><span style="padding:3px 8px; border-radius:4px; background:#f39c12; color:white; font-size:0.7rem; font-weight:bold;">${status}</span></td>
                                <td>${resp}</td>
                                <td style="font-size:0.75rem; color:#e74c3c;">${obs}</td>
                            </tr>
                        `;
                    }).join('');
                    break;

                default: // 'Inventario'
                    headers = ['Código', 'Descripción', 'Marca/Modelo', 'Serie', 'Departamento', 'Estado'];
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron artículos con los filtros seleccionados.</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = data.map(item => {
                        const code = item.Codigo || item.codigo || item.id || item.ID || 'S/C';
                        const desc = item.Nombre || item.nombre || item.Descripción || item.descripcion || item.Articulo || '---';
                        const marca = item.Marca || item.marca || 'S/D';
                        const modelo = item.Modelo || item.modelo || 'S/D';
                        const brandModel = `${marca} ${modelo}`.trim();
                        const serial = item.Serie || item.serie || item['Numero de Serie'] || item.Numero_Serie || 'S/N';
                        const dept = item.Departamento || item.departamento || 'S/A';
                        const status = (item.Estado || item.estado || 'ACTIVO').toUpperCase();

                        return `
                            <tr>
                                <td style="font-weight:bold; color:#0066cc;">${code}</td>
                                <td style="text-transform:uppercase;">${desc}</td>
                                <td>${brandModel}</td>
                                <td>${serial}</td>
                                <td style="color:#2ecc71;">${dept}</td>
                                <td><span style="padding:3px 8px; border-radius:4px; background:#f0f0f0; font-size:0.7rem; font-weight:bold;">${status}</span></td>
                            </tr>
                        `;
                    }).join('');
            }
        }

        function exportFormat(format) {
            UI.showToast(`Generando ${format}...`, "info");
            if (format === 'PDF') {
                window.print();
            } else if (format === 'Excel') {
                const table = document.getElementById('data-table');
                const wb = XLSX.utils.table_to_book(table, { sheet: "Reporte" });
                XLSX.writeFile(wb, `Reporte_SIBIM_${currentReportType}_${new Date().getTime()}.xlsx`);
            } else if (format === 'CSV') {
                const table = document.getElementById('data-table');
                const wb = XLSX.utils.table_to_book(table);
                XLSX.writeFile(wb, `Reporte_SIBIM_${currentReportType}_${new Date().getTime()}.csv`, { bookType: 'csv' });
            }
        }

        async function applyFilters() {
            UI.showToast("Aplicando filtros personalizados...", "info");
            const dateStart = document.getElementById('filter-date-start').value;
            const dateEnd = document.getElementById('filter-date-end').value;
            const dept = document.getElementById('filter-dept').value;
            const status = document.getElementById('filter-status').value;
            const typeFilter = document.getElementById('filter-type').value;

            try {
                let filtered = await API.fetchItems();

                if (dept && dept !== 'Todos los departamentos') {
                    filtered = filtered.filter(i => (i.Departamento || i.departamento || '') === dept);
                }
                if (status && status !== 'Todos los estados') {
                    filtered = filtered.filter(i => (i.Estado || i.estado || '').toUpperCase() === status.toUpperCase());
                }
                if (typeFilter && typeFilter !== 'Todos los tipos') {
                    filtered = filtered.filter(i => (i.Tipo || i.Categoria || i.tipo || i.categoria || '') === typeFilter);
                }

                // Filtro de fechas (requiere campo de fecha en los datos)
                if (dateStart) {
                    const start = new Date(dateStart);
                    filtered = filtered.filter(i => {
                        const dateStr = i.Fecha || i.fecha || i.Fecha_Adquisicion || i.fecha_adquisicion;
                        if (!dateStr) return true;
                        return new Date(dateStr) >= start;
                    });
                }
                if (dateEnd) {
                    const end = new Date(dateEnd);
                    filtered = filtered.filter(i => {
                        const dateStr = i.Fecha || i.fecha || i.Fecha_Adquisicion || i.fecha_adquisicion;
                        if (!dateStr) return true;
                        return new Date(dateStr) <= end;
                    });
                }

                currentReportData = filtered;
                renderReportTable(filtered, currentReportType || 'Inventario');
                document.getElementById('report-title-text').textContent = `REPORTE PERSONALIZADO (${(currentReportType || 'Inventario').toUpperCase()})`;
                document.getElementById('printable-report').style.display = 'block';
                UI.showToast(`Filtros aplicados: ${filtered.length} artículos encontrados`, "success");
            } catch (err) {
                UI.showToast("Error al aplicar filtros", "error");
                Logger.error('Error en filtros:', err);
            }
        }

        function clearFilters() {
            UI.showToast("Limpiando filtros...", "info");
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-dept').selectedIndex = 0;
            document.getElementById('filter-status').selectedIndex = 0;
            document.getElementById('filter-type').selectedIndex = 0;
            setTimeout(() => generateReport('Inventario'), 300);
        }
    </script>
</body>

</html>