<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 40px;
            bottom: -30px;
            width: 2px;
            background: var(--glass-border);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-icon {
            width: 50px;
            height: 50px;
            background: var(--card-bg);
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 1;
        }

        .timeline-content {
            flex: 1;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
        }

        .type-badge {
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: bold;
        }

        .type-create {
            background: #2ecc7122;
            color: #2ecc71;
        }

        .type-update {
            background: #3498db22;
            color: #3498db;
        }

        .type-status {
            background: #f1c40f22;
            color: #f1c40f;
        }
    </style>
</head>

<body>
    <header
        style="padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2);">
        <div class="logo" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-blue);">
            <i class="fas fa-history" style="margin-right: 10px;"></i>Historial de Movimientos
        </div>
        <a href="../index.html" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Volver al Dashboard</a>
    </header>

    <main style="padding: 30px 5%;">
        <!-- Action Buttons -->
        <div style="display: flex; gap: 15px; margin-bottom: 30px;">
            <button class="btn btn-primary" style="padding: 12px 25px; border-radius: 8px; font-weight: bold;"
                onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i> GENERAR REPORTE
            </button>
            <button class="btn"
                style="padding: 12px 25px; border-radius: 8px; font-weight: bold; background: #f39c12; color: white;"
                onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> EXPORTAR EXCEL
            </button>
            <button class="btn btn-danger" style="padding: 12px 25px; border-radius: 8px; font-weight: bold;"
                onclick="clearHistory()">
                <i class="fas fa-trash-alt"></i> LIMPIAR HISTORIAL
            </button>
        </div>

        <!-- Filters Section -->
        <div class="glass" style="padding: 25px; border-radius: 15px; margin-bottom: 30px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                <div class="form-group">
                    <label
                        style="color: #9b59b6; font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block;">Filtrar
                        por Tipo</label>
                    <select id="filter-type" class="form-control glass" onchange="filterMovements()"
                        style="color: grey;">
                        <option value="">Todos los tipos</option>
                        <option value="Sincronización">Sincronización</option>
                        <option value="Alta">Alta</option>
                        <option value="Actualización">Actualización</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
                <div class="form-group">
                    <label
                        style="color: #9b59b6; font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block;">Filtrar
                        por Usuario</label>
                    <select id="filter-user" class="form-control glass" onchange="filterMovements()"
                        style="color: grey;">
                        <option value="">Todos los usuarios</option>
                        <!-- To be populated via JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label
                        style="color: #9b59b6; font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block;">Fecha
                        Desde</label>
                    <input type="date" id="date-from" class="form-control glass" onchange="filterMovements()"
                        style="color: grey;">
                </div>
                <div class="form-group">
                    <label
                        style="color: #9b59b6; font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block;">Fecha
                        Hasta</label>
                    <input type="date" id="date-to" class="form-control glass" onchange="filterMovements()"
                        style="color: grey;">
                </div>
            </div>
        </div>

        <!-- Movements Table -->
        <div class="glass" style="padding: 0; overflow: hidden; border-radius: 15px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: linear-gradient(90deg, #3498db, #5e35b1); color: white;">
                        <th style="padding: 15px; text-align: left;">ID</th>
                        <th style="padding: 15px; text-align: left;">FECHA</th>
                        <th style="padding: 15px; text-align: left;">USUARIO</th>
                        <th style="padding: 15px; text-align: left;">ACCIÓN</th>
                        <th style="padding: 15px; text-align: left;">TIPO</th>
                        <th style="padding: 15px; text-align: left;">DETALLES</th>
                    </tr>
                </thead>
                <tbody id="movements-table-body" style="background: white; color: #333;">
                    <tr>
                        <td colspan="6" style="padding: 50px; text-align: center; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> Cargando historial...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        let allMovements = [];

        document.addEventListener('DOMContentLoaded', async () => {
            Auth.checkAccess();
            Auth.initTheme();
            loadMovements();
        });

        async function loadMovements() {
            const tbody = document.getElementById('movements-table-body');
            try {
                allMovements = await API.getMovements();
                populateUserFilter(allMovements);
                renderMovements(allMovements);
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:20px;">Error al conectar con la base de datos cloud.</td></tr>`;
            }
        }

        function populateUserFilter(data) {
            const userSelect = document.getElementById('filter-user');
            const users = [...new Set(data.map(m => m.Usuario || m.usuario).filter(Boolean))];
            users.sort().forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                userSelect.appendChild(opt);
            });
        }

        function renderMovements(data) {
            const tbody = document.getElementById('movements-table-body');
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color: #666;">No se encontraron registros de movimientos.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(m => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px 15px; font-weight: bold;">${m.ID || m.id || '---'}</td>
                    <td style="padding: 12px 15px;">${m.Fecha || m.fecha || '---'}</td>
                    <td style="padding: 12px 15px;">${m.Usuario || m.usuario || '---'}</td>
                    <td style="padding: 12px 15px;">${m.Accion || m.accion || '---'}</td>
                    <td style="padding: 12px 15px;">
                        <span class="badge" style="background: ${getTypeColor(m.Tipo || m.tipo || 'Alta')}; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem;">
                            ${m.Tipo || m.tipo || 'Alta'}
                        </span>
                    </td>
                    <td style="padding: 12px 15px; font-size: 0.85rem; color: #666;">${m.Detalles || '---'}</td>
                </tr>
            `).join('');
        }

        function getTypeColor(type) {
            if (!type) return '#95a5a6';
            const t = type.toLowerCase();
            if (t.includes('sincro')) return '#3498db'; // Azul
            if (t.includes('alta')) return '#2ecc71';  // Verde
            if (t.includes('actualiza')) return '#9b59b6'; // Morado
            if (t.includes('baja')) return '#e74c3c'; // Rojo
            return '#2ecc71';
        }

        function filterMovements() {
            const type = document.getElementById('filter-type').value.toLowerCase();
            const user = document.getElementById('filter-user').value.toLowerCase();
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;

            const filtered = allMovements.filter(m => {
                const mType = (m.Tipo || m.tipo || '').toLowerCase();
                const mUser = (m.Usuario || m.usuario || '').toLowerCase();
                const mDate = (m.Fecha || m.fecha || '').split(' ')[0];

                const matchType = !type || mType.includes(type);
                const matchUser = !user || mUser === user;
                const matchDateFrom = !dateFrom || mDate >= dateFrom;
                const matchDateTo = !dateTo || mDate <= dateTo;

                return matchType && matchUser && matchDateFrom && matchDateTo;
            });

            renderMovements(filtered);
            UI.showToast(`${filtered.length} movimientos encontrados`, "info");
        }

        function clearHistory() {
            if (confirm('¿Estás seguro de que deseas limpiar el historial local? Esta acción no borrará los datos de la nube.')) {
                allMovements = [];
                renderMovements([]);
            }
        }

        function exportToPDF() {
            if (allMovements.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            window.print();
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('Librería XLSX no cargada. Por favor recarga la página.');
                return;
            }
            const table = document.querySelector('table');
            const wb = XLSX.utils.table_to_book(table, { sheet: "Movimientos" });
            XLSX.writeFile(wb, `SIBIM_Movimientos_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
    </script>
</body>

</html>