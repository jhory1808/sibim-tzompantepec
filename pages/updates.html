<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Actualizaciones - SIBIMTZOMP</title>
    <link rel="stylesheet" href="../css/futuristic.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body class="theme-dark">
    <header style="height: 100px; display: flex; justify-content: space-between; align-items: center; padding: 0 5%;">
        <div class="logo" style="display: flex; align-items: center; gap: 20px;">
            <img src="../assets/images/logo_municipio.png" style="height: 70px;">
            <span style="font-size: 1.8rem; font-weight: 800; color: #00d2ff; letter-spacing: 2px;">SIBIMTZOMP</span>
        </div>
        <div style="display: flex; align-items: center; gap: 25px;">
            <img src="../assets/images/escudo.png" style="height: 60px;" alt="Escudo Tzompantepec">
            <a href="../index.html" class="btn btn-outline"
                style="border-radius: 50px; padding: 10px 30px; font-weight: bold; border-color: #00d2ff; color: #00d2ff;">VOLVER</a>
        </div>
    </header>

    <div style="text-align: center; padding: 20px 0; margin-top: 10px;">
        <h1
            style="color: #00d2ff; font-size: 3rem; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; line-height: 1.1;">
            Registro de Actualizaciones
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem; opacity: 0.7;">Auditoría completa de cambios en el
            sistema</p>
    </div>

    <main style="padding: 20px 5%;">
        <div class="glass" style="padding: 30px; border-radius: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="color: #00d2ff; font-size: 1.3rem;">
                    <i class="fas fa-history"></i> HISTORIAL DE ACTUALIZACIONES
                </h3>
                <button class="btn" style="background: #00d2ff; color: #0a0e27; font-weight: bold; padding: 12px 25px;"
                    onclick="loadUpdates()">
                    <i class="fas fa-sync-alt"></i> ACTUALIZAR LISTADO
                </button>
            </div>

            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="background: rgba(0, 210, 255, 0.1); border-bottom: 2px solid #00d2ff;">
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">ID</th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Fecha/Hora
                            </th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Usuario</th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Tipo</th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Tabla</th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">ID Registro
                            </th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Campo</th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Valor
                                Anterior</th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Valor Nuevo
                            </th>
                            <th style="padding: 15px; text-align: left; font-weight: 700; color: #00d2ff;">Descripción
                            </th>
                            <th style="padding: 15px; text-align: center; font-weight: 700; color: #00d2ff;">Versión/IP
                            </th>
                        </tr>
                    </thead>
                    <tbody id="updates-table-body">
                        <tr>
                            <td colspan="11" style="text-align:center; padding:40px; color:#8892b0;">
                                <i class="fas fa-info-circle" style="font-size:2rem; margin-bottom:10px;"></i>
                                <div>Haz clic en "ACTUALIZAR LISTADO" para cargar las actualizaciones</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="../js/config.js?v=2.1.0"></script>
    <script src="../js/api.js?v=2.1.0"></script>
    <script src="../js/auth.js?v=2.1.0"></script>
    <script src="../js/app.js?v=2.1.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            Auth.checkAccess();
            Auth.initTheme();
            // Cargar automáticamente al iniciar
            loadUpdates();
        });

        async function loadUpdates() {
            const tbody = document.getElementById('updates-table-body');
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Cargando actualizaciones...</td></tr>';

            try {
                UI.showToast("Cargando registro de actualizaciones...", "info");
                const updates = await API.getUpdates();

                if (!updates || updates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:30px; color:#8892b0;">No hay actualizaciones registradas en el sistema.<br><small style="margin-top:10px; display:block;">Las actualizaciones se registran automáticamente cuando se realizan cambios en el inventario.</small></td></tr>';
                    UI.showToast("No se encontraron actualizaciones", "warning");
                    return;
                }

                tbody.innerHTML = updates.map((update, index) => `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 12px 15px; font-weight:bold; color:#00d2ff;">${update.ID || index + 1}</td>
                        <td style="padding: 12px 15px;">
                            <div>${update['Fecha/Hora'] || update.Fecha || update.fecha || '---'}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">${update.Hora || update.hora || ''}</div>
                        </td>
                        <td style="padding: 12px 15px; font-weight:600;">${update.Usuario || update.usuario || 'Sistema'}</td>
                        <td style="padding: 12px 15px;"><span style="padding:3px 10px; border-radius:4px; background:rgba(0,210,255,0.2); color:#00d2ff; font-size:0.75rem; font-weight:bold;">${update.Tipo || update.tipo || 'Actualización'}</span></td>
                        <td style="padding: 12px 15px;">${update['Tabla Afectada'] || update.tabla || '---'}</td>
                        <td style="padding: 12px 15px; font-family: monospace;">#${update['ID Registro'] || update.idRegistro || '---'}</td>
                        <td style="padding: 12px 15px; color: var(--accent-blue);">${update['Campo Modificado'] || update.campo || '---'}</td>
                        <td style="padding: 12px 15px; color: #e74c3c;">${update['Valor Anterior'] || update.valorAnterior || '---'}</td>
                        <td style="padding: 12px 15px; color: #2ecc71;">${update['Valor Nuevo'] || update.valorNuevo || '---'}</td>
                        <td style="padding: 12px 15px; font-size: 0.75rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${update.Descripcion || update.descripcion || '---'}</td>
                        <td style="padding: 12px 15px; text-align: center;">
                            <div style="font-weight: bold;">v${update.Version || update.version || '1.0'}</div>
                            <div style="font-size: 0.65rem; color: var(--text-secondary);">${update.IP || update.ip || '---'}</div>
                        </td>
                    </tr>
                `).join('');

                UI.showToast(`${updates.length} actualizaciones cargadas`, "success");
            } catch (error) {
                Logger.error('Error al cargar actualizaciones:', error);
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:20px; color:#e74c3c;"><i class="fas fa-exclamation-triangle"></i> Error al cargar las actualizaciones. Verifica la conexión con el servidor.</td></tr>';
                UI.showToast("Error al cargar actualizaciones", "error");
            }
        }
    </script>
</body>

</html>